## Опис протоколу обміну

### Додаток

Додаток, після запуску, підʼєднується до брокера та робить підписки на наступні топіки:

```
delfast_charger/$id/data
delfast_charget/$id/charger_status
```

Після цього він відправляє повідомлення 'check' у топік __delfast_charget/$id/command__
Зарядна станція, побачивши це повідомлення, посилає у топік __delfast_charget/$id/charger_status__ повідомлення 'ready'
(або інший свій наявний статус).
Якшо після відправки 'check' не приходить повідомлення 'ready' у топік протягом деякого часу,
то вважається шо зарядна станція не підʼєднана до брокеру і видається повідомлення
про помилку:

```
'Зарядна станція не відповідає. Зачекайте декілька хвилин. Якшо помилка не зникне, зверніться в технічну підтримку.'
```

Після того як додаток визначив шо клієнт має достатньо коштів на рахунку, та кліент натиснув кнопку
'Відкрити зарядну станцію', додаток посилає повідомлення 'init' у топік __delfast_charger/$id/command__
Зарядна станція відімкне дверцята (подає 2 секунди сигнал на вихід TurnL, активує струм у розетку) і,
пошле у топік __delfast_charget/$id/charger_status__ новий статус 'init'.

Клієнт під'єднує дріт зарядки, зарядна станія це бачить та змінює статус на 'charging', відправляє у топік
__delfast_charget/$id/charger_status__.

Зарядна станція посилає у топік __delfast_charger/$id/data__ пакети наступного формату:

```json
{
    "status": "charging",
    "charging_started": 1681592824,
    "charging_time_secs": 500,
    "door_closed": false,
    "current_mA": 15000,
    "voltage_V": 110,
    "power_W": 300,
    "pf_perc": 100,
    "energy_Wh": 20,
}
```

Значення струму передаються у мілліамперах.
Значення напруги у вольтах.
Значення потужності у ватах (вимірюються у 0.1Вт).
Значення споживання у ват х годинах.
Значення power factor у відсотках.

Зарядна станція посилає ций пакет кожну секунду на протязі 10 хвилин після будь якої команди від додатку
через топік __delfast_charger/$id/command__ або після отримання 'check' у топік __delfast_charget/$id/charger_status__.
Через 10 хвилин і надалі, зарядна станція посилає пакети раз на 30 секунд, або одразу, якшо струм споживання
впаде нижче 10% від максимального, під час заряджання, рівня (завершення заряджання).

Коли рівень заряджання впаде нижче 10%, то додаток видає повідомлення шо заряджання завершено.
Зарядна станція переходить у стан 'completed', передає його у __delfast_charget/$id/charger_status__.

Додаток рахує витрати по формулі:

```
charging_time_secs * V1 + energy_Wh * V2
```
, де

`V1` - ціна секунди аренди зарядної станції

`V2` - ціна одного вата енергії

Додаток показує шо пішла зарядка, показує наявну потужність, показує хвилини заряджання, тощо.
Також попереджає шо потрібно закрити дверцята зарядки.
Клієнт закриває дверцята, в пакеті поле "door_closed" змінюється на __true__.




### Зарядна станція

Зарядна станція утримує зʼєднання з брокером.

При підʼєданні, робить підпису до наступних топіків:

```
delfast_charger/$id/command
delfast_charget/$id/charger_status
```

Після підʼєднання посилає у топік __delfast_charget/$id/charger_status__ повідомлення 'ready'.
Якшо отримує повідомлення 'check' у топіку __delfast_charget/$id/charger_status__, то повторно
посилає повідомлення 'ready' у топік __delfast_charget/$id/charger_status__.
