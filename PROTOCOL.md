## Опис протоколу обміну

### Додаток

QR-код містить ідентифікатор зарядної станції __$id__. 

Додаток, після запуску, авторизації користувача (__$uid__), та переконання шо у користувача достатньо коштів на рахунку,
підʼєднується до брокера та робить підписки на наступні топіки:

```
charger/$id/status
```

Після цього відправляє повідомлення 'hello' у топік __charger/$id/commands__.
Зарядна станція, побачивши це повідомлення, посилає у топік __charger/$id/status__ свій наявний стан:

```json
{
    "status": "ready",
    "doors_opened": false,
    "out_active": false,
    "common_energy": 100,
}
```

Значення потужності common_power у ватгодинах (вимірюються з кроком 0.5Вт*г).


(або інший свій наявний статус).
Якшо зарядна станція знаходиться у статусі виконання (busy, charging, etc), статус буде мати
наступний вигляд:

```json
{
    "status": "busy",
    "doors_opened": false,
    "uid": "$uid",
    "common_energy": 100,
    ...
}
```

Якшо __$uid__ у статусі відрізняється від __id__ користувача додатку, то необхідно видати
повідомлення:

```
Зарядна станція використовується іншим користувачем. Оберіть іншу станцію, або спробуйте пізніше.
Або якшо ви фізично бачете шо станція не використовується, зверніться в технічну підтримку.
```

Якшо після відправки 'hello' не приходять дані у топік протягом деякого часу (15 секунд),
то вважається шо зарядна станція не підʼєднана до брокеру і видається повідомлення
про помилку:

```
'Зарядна станція не відповідає. Зачекайте декілька хвилин. Якшо помилка не зникне, зверніться в технічну підтримку.'
```

Після того як кліент натиснув кнопку 'Відкрити зарядну станцію, aбо активувати розетку 110V', додаток посилає повідомлення
'connect:$uid:config_string' у топік __charger/$id/commands__
Зарядна станція відімкне дверцята (подає 2 секунди сигнал на вихід TurnL, активує струм у розетку) і,
пошле у топік __charger/$id/status__ новий статус 'busy'.

```json
{
    "status": "busy",
    "uid": "$uid",
    "common_energy": 100,
    "time": 0,
    "pause_time": 0,
    "voltage": $voltage,
    "current": $current,
    "power": $power,
    "energy": $energy,
    "frequency": $frequency,
    "pf": $pf
}
```

Формат **config_string**.
Параметри передаються чезез подільник ':'.
Перелік параметрів:

параметр | Опис
-----|------------------------------------------------------------
B<n> | Вибір бабіни. B0 - універсальний порт, B1...B4 - бабіни 1..4. Якшо параметр відсутній, то обирається порт 110V.
U<v> | Напруга блока живлення. Контролер контролює напругу перед активацією | бабіни (B1...B4). При відсутності параметру B<n>, цей параметр ігнорується, або його можна не передавати.
P<n> | Конфігурація параметрів регульованого блока живлення. n - десятичне значення, двоїчна форма відповідає комбінації виходів регулювання блока живлення. P1=42V,2A; P3=42V,3A; P7=54.6V,2A; P15=54.6V,3A; P14=58.8V;3A; P0=0V,0A

Приклади повної команди:
```
connect:lDpl3b3d21Ma0vUBoMYdJuoOsVI3:B1:U54.6:P7
connect:lDpl3b3d21Ma0vUBoMYdJuoOsVI3:P0
```


З цього моменту, значення time буде зростати на 1 кожну секунду.
~~З цього моменту зарядна станція буде сприймати тільки команди з вказаним __$uid__, інші буде ігнорувати.~~

Клієнт відкриває дверцята, під'єднує дріт зарядки, закриває дверцята, через 5 секунд зарядна станія змінює статус на 'charging', відправляє у топік
__charger/$id/status__.

```json
    {
        "status": "charging",
        "uid": "$uid",
        "common_energy": 100,
        "time": $time,
        "pause_time": 0,
        "voltage": $voltage,
        "dc_voltage": $voltage,
        "current": $current,
        "power": $power,
        "energy": $energy,
        "frequency": $frequency,
        "pf": $pf
    }
```

Значення струму передаються у мілліамперах.
Значення напруги у вольтах.
Значення потужності у ватах (вимірюються у 0.1Вт).
Значення споживання у ват х годинах.
Значення power factor у відсотках.

Зарядна станція посилає ций пакет кожні 5 секунд на протязі 10 хвилин після будь якої команди від додатку
через топік __charger/$id/commands__, якшо значення __$uid__ співпало з id користувача.
Через 10 хвилин і надалі, зарядна станція посилає пакети раз на 60 секунд, або одразу, якшо міняєтся її стан (струм споживання
впаде нижче 10% від максимального рівня - завершення заряджання), або користувач припинив зарядку.

Процес заряджання може бути призупинен передачею команди "pause:$uid" у топік __charger/$id/commands__.

```json
    {
        "status": "paused",
        "uid": "$uid",
        "common_energy": 100,
        "time": $time,
        "pause_time": $pause_time,
        "voltage": $voltage,
        "dc_voltage": $voltage,
        "current": $current,
        "power": $power,
        "energy": $energy,
        "frequency": $frequency,
        "pf": $pf
    }
```

Зарядна станція вимикає напругу з портів заряджання.
З цього моменту, значення __pause_time__ буде зростати на 1 кожну секунду.

Продовжити процес заряджання можна передавши команду "continue:$uid" у топік __charger/$id/commands__.
Або можна припинити заряджання командою "stop:$uid" (див. далі).

Коли рівень заряджання впаде нижче 10%, то додаток видає повідомлення шо заряджання завершено.
Зарядна станція переходить у стан 'completed', передає його у __charger/$id/status__.

```json
    {
        "status": "completed",
        "uid": "$uid",
        "common_energy": 100,
        "time": $time,
        "pause_time": $pause_time,
        "voltage": $voltage,
        "dc_voltage": $voltage,
        "current": $current,
        "power": $power,
        "energy": $energy,
        "frequency": $frequency,
        "pf": $pf
    }
```

Зарядна станція продовжує рахувати витрати енергій, та час аренди станції.

Додаток рахує витрати по формулі:

```
charging_time_secs * V1 + energy_Wh * V2
```
, де

`V1` - ціна секунди аренди зарядної станції

`V2` - ціна одного вата енергії

Користувач, повернувшись до зярядної станції, натискає у додатку кнопку "Припинити заряджання".
Він це може робити у режимах: "busy", "charging", і "completed".
Додаток посилає у топік __charger/$id/commands__ команду "stop:$uid".
Дверцята відкриваються, струм знімається, індикатор гасне.
Станція посилає свій стан:

```json
    {
        "status": "done",
        "uid": "lDpl3b3d21Ma0vUBoMYdJuoOsVI3",
        "common_energy": 100,
        "time": $time,
        "pause_time": $pause_time,
        "voltage": $voltage,
        "dc_voltage": $voltage,
        "current": $current,
        "power": $power,
        "energy": $energy,
        "frequency": $frequency,
        "pf": $pf
    }
```

У додатку видається інструкция: Відкрийте дверцята, відʼєднайте дроти, закрийте дверцята.
Після цього станція автоматично перейде у стан 'ready'. Вона доступна до нового підʼєднання.
Сервер може примусово перевести станцію у стан 'ready' може відправивши команду 'break'.

У додатку проходить списання с балансу (або списання робити динамічне у всьому процесі заряджання).


### Зарядна станція

Зарядна станція утримує постійне зʼєднання з брокером.

При підʼєданні, робить підпису до топіків
* __charger/$id/commands__
* __charger/commands__


Після підʼєднання посилає у топік __charger/$id/status__ свій наявний статус.
Якшо отримує повідомлення 'hello:$uid' у топіку __charger/$id/commands__, то повторно
посилає свій статус у топік __charger/$id/status__.
Якшо отримує повідомлення 'hello' у топік __charger/commands__, то теж посилає свій статус у топік __charger/$id/status__.

Зарядна станція може бути у таких станах:

- init - Ініціалізація обладнання.
- ready - Станція вільна, та очікує підʼєднання користувача. Струм вимкнено, дверцята закриті, індикація вимкнена.
- busy - Користувач підʼєднався до станціі. Дверцята відкриті, струм подано, індикація вимкнена.
- charging - Користувач все підʼєднав, затворив дверцята. Дверцята закриті, струм подано, індикація процеса заряджання (блимає).
- completed - Струм нижче якогось рівня. Дверцята закриті, струм подано, індикація горить постійно.
- done - Дверцята відкриті, струм вимкнено, індикація вимкнена.
- error - Критична помилка. Подальша робота неможлива.
- maintenance - Станція на обслуговані, наприклад, оновлення ПЗ.
- off - Станція вимкнена
- ignore_me - Воркер повинен ігнорувати пакет з цим станом. Сподіваюсь це тимчасова заплатка.

P.S.
Ще треба описати непередбачувані ситуаціі. Наприклад, шо робити якшо клієнт відкрив станцію, та убіг назавжди. Чи десь порушеня якась послідовність дій. Чи дверцята не закрив. Чи може ще щось. Станів може бути більше ніж у переліку.

Стан "error":
```json
{
    "status": "error",
    "code": $errorcode,
    "reason": "Text comment if it possible",
    "common_energy": 100
}
```

Можливі помилки $errorcode:

- __11__ - Відсутній звʼязок з модулем вимірювання.



## Внутрішні команди

Для __charger/commands__ (G), та __charger/$id/commands__ (L) є набір команд для сервісного використання:

Можливо буде додано щось на кшталт __$API_SERVICE_KEY:$commad[:$params]__:

* (L) reinit - Гарячя переініціалізація у стан __"ready"__
* (L) reboot - Примусове повне перезавантаження зарядної станціі зі сбросом у початковий стан __"ready"__.
* (L,G) fwupdate:name - Оновлення програмного забеспечення зарядної станції