## Опис протоколу обміну

### Додаток

QR-код містить ідентифікатор зарядної станції __$id__. 

Додаток, після запуску, авторизації користувача (__$uid__), та переконання шо у користувача достатньо коштів на рахунку,
підʼєднується до брокера та робить підписки на наступні топіки:

```
charger/$id/status
charget/$id/$uid/status (?)
```

Після цього відправляє повідомлення 'hello:$userid' у топік __charger/$id/commands__
Зарядна станція, побачивши це повідомлення, посилає у топік __charger/$id/status__ свій наявний стан:

```json
{
    "status": "ready",
    "doors_closed": true,
    "out_active": false
}
```

(або інший свій наявний статус).
Якшо зарядна станція знаходиться у статусі виконання (busy, charging, etc), статус буде мати
наступний вигляд:

```json
{
    "status": "busy",
    "uid": "$uid",
    ...
}
```

Якшо __$userid__ у статусі відрізняється від __id__ користувача додатку, то необхідно видати
повідомлення:

```
Зарядна станція використовується іншим користувачем. Оберіть іншу станцію, або спробуйте пізніше.
Або якшо ви фізично бачете шо станція не використовується, зверніться в технічну підтримку.
```

Якшо після відправки 'hello:$userid' не приходять дані у топік протягом деякого часу (15 секунд),
то вважається шо зарядна станція не підʼєднана до брокеру і видається повідомлення
про помилку:

```
'Зарядна станція не відповідає. Зачекайте декілька хвилин. Якшо помилка не зникне, зверніться в технічну підтримку.'
```

Після того як кліент натиснув кнопку 'Відкрити зарядну станцію', додаток посилає повідомлення
'connect:$userid' у топік __charger/$id/commands__
Зарядна станція відімкне дверцята (подає 2 секунди сигнал на вихід TurnL, активує струм у розетку) і,
пошле у топік __charger/$id/status__ новий статус 'busy'.

```json
{
    "status": "busy",
    "uid": "$uid",
    "time": 0,
    "voltage": $voltage,
    "current": $current,
    "power": $power,
    "energy": $energy,
    "frequency": $frequency,
    "pf": $pf
}
```

З цього моменту, значення time буде зростати на 1 кожну секунду.

Клієнт під'єднує дріт зарядки, зарядна станія це бачить та змінює статус на 'charging', відправляє у топік
__charger/$id/status__.

```json
    {
        "status": "charging",
        "uid": "lDpl3b3d21Ma0vUBoMYdJuoOsVI3",
        "time": $time,
        "voltage": $voltage,
        "current": $current,
        "power": $power,
        "energy": $energy,
        "frequency": $frequency,
        "pf": $pf
    }
```

Значення струму передаються у мілліамперах.
Значення напруги у вольтах.
Значення потужності у ватах (вимірюються у 0.1Вт).
Значення споживання у ват х годинах.
Значення power factor у відсотках.

Зарядна станція посилає ций пакет кожну секунду на протязі 10 хвилин після будь якої команди від додатку
через топік __charger/$id/commands__, якшо значення $uid співпало з id користувача.
Через 10 хвилин і надалі, зарядна станція посилає пакети раз на 30 секунд, або одразу, якшо струм споживання
впаде нижче 10% від максимального рівня (завершення заряджання).

Коли рівень заряджання впаде нижче 10%, то додаток видає повідомлення шо заряджання завершено.
Зарядна станція переходить у стан 'completed', передає його у __charger/$id/status__.

```json
    {
        "status": "completed",
        "uid": "lDpl3b3d21Ma0vUBoMYdJuoOsVI3",
        "time": $time,
        "voltage": $voltage,
        "current": $current,
        "power": $power,
        "energy": $energy,
        "frequency": $frequency,
        "pf": $pf
    }
```

Зарядна станція продовжує рахувати витрати енергій, та час аренди станції.

Додаток рахує витрати по формулі:

```
charging_time_secs * V1 + energy_Wh * V2
```
, де

`V1` - ціна секунди аренди зарядної станції

`V2` - ціна одного вата енергії

Користувач, повернувшись до зярядної станції, натискає у додатку кнопку "Припинити заряджання".
Він це може робити як з режиму "charging", так і з "completed".
Додаток посилає у топік __charger/$id/commands__ команду "stop:$uid".
Дверцята відкриваються, струм знімається, індикатор гасне.
Станція посилає свій стан:

```json
    {
        "status": "done",
        "uid": "lDpl3b3d21Ma0vUBoMYdJuoOsVI3",
        "time": $time,
        "voltage": $voltage,
        "current": $current,
        "power": $power,
        "energy": $energy,
        "frequency": $frequency,
        "pf": $pf
    }
```

У додатку видається інструкция: Відкрийте дверцята, відʼєднайте дроти, закрийте дверцята.
Після цього станція автоматично перейде у стан 'ready'. Вона доступна до нового підʼєднання.

У додатку проходить списання с балансу (або списання робити динамічне у всьому процесі заряджання).


### Зарядна станція

Зарядна станція утримує постійне зʼєднання з брокером.

При підʼєданні, робить підпису до топіка __charger/$id/commands__.
Після підʼєднання посилає у топік __charger/$id/status__ свій наявний статус.
Якшо отримує повідомлення 'hello:$uid' у топіку __charger/$id/commands__, то повторно
посилає свій статус у топік __charger/$id/status__.

Зарядна станція може бути у таких станах:

- init - Ініціалізація обладнання.
- ready - Станція вільна, та очікує підʼєднання користувача. Струм вимкнено, дверцята закриті, індикація вимкнена.
- busy - Користувач підʼєднався до станціі. Дверцята відкриті, струм подано, індикація вимкнена.
- charging - Користувач все підʼєднав, затворив дверцята. Дверцята закриті, струм подано, індикація процеса заряджання (блимає).
- completed - Струм нижче якогось рівня. Дверцята закриті, струм подано, індикація горить постійно.
- done - Дверцята відкриті, струм вимкнено, індикація вимкнена.
